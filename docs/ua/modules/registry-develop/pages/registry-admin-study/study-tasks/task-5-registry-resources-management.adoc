= Завдання 5. Керування ресурсами реєстру
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

== Мета завдання

Виконання цього завдання має на меті: ::

* [*] Навчити керувати ресурсами реєстру на прикладі налаштування лімітів контейнерів пам’яті та CPU. Це запобігатиме надмірному використанню ресурсів окремими контейнерами та забезпечує ефективний розподіл ресурсів між сервісами.

[NOTE]
====
Щоб Kubernetes-кластер працював стабільно, необхідно правильно налаштувати ресурси для кожного контейнера — *пам’ять і CPU*.

* Встановлюйте однакові значення *Request і Limit* для пам’яті контейнерів в OKD/Kubernetes. Якщо не встановити ліміти пам’яті для контейнерів, то при різкому зростанні споживання пам’яті контейнер може перевищити доступні ресурси. Це може знизити продуктивність або спричинити аварійне завершення роботи інших контейнерів на ноді.


* Використовуйте *НЕ більше 3 реплік* одного сервісу. Особливо для Java-застосунків ефективнішим є вертикальне масштабування — збільшення ресурсів для однієї репліки, а не створення додаткових. Використання понад 3 реплік для сервісу із Java-застосунками призведе до суттєвого збільшення споживання пам’яті через значне використання ресурсів кожною реплікою. Це неефективно розподілить ресурси, що погіршить загальну продуктивність системи.
====

== Передумови

. Ознайомтеся із можливими доступними для налаштування сервісами та процедурою внесення змін на сторінці
 xref:admin:registry-management/control-plane-registry-resources.adoc[Керування ресурсами реєстру].

== Процес виконання завдання

Налаштуйте сервіс `Container limits` компоненти bpms реєстру, використовуючи інструкцію, наведену нижче.

. Перевірте поточний стан  в консолі OKD.
Відкрийте OpenShift (Console),  меню Workloads (попередньо обравши потрібний проект, якщо вам доступно декілька проектів) в пункті Deployments знайдіть bpms
image:registry-admin-study/task-registry-resources-management/image-1.png[]
На вкладці Environment ми побачимо поточні значення.
image:registry-admin-study/task-registry-resources-management/image-2.png[]

. Перейдіть до редагування реєстру та відкрийте вкладку Ресурси реєстру. Оберіть в переліку компонент bpms, натисніть «Додати».
image:registry-admin-study/task-registry-resources-management/image-3.png[]
В «змінних оточення» змінна JAVA_OPTS має дефолтне значення Value  -Xms1536m -Xmx1536m
(Xms – скільки ресурсів виділяємо для java-додатку, Xmx – це максимум.)

. Внесіть нове значення -Xms2000m -Xmx2000m (завжди виставляємо однакові значення в обох параметрах).
Якщо ви збільшуєте ці параметри, то також не забудьте встановіти ліміти Container limits (не переплутайте з лімітами на ISTIO SIDECAR).
. Встановіть значення 3500Mi в оба поля

image:registry-admin-study/task-registry-resources-management/image-4.png[]
[NOTE]
====
Зверніть увагу, що дані значення використовуються у завданні як приклад для ознайомлення. Рекомендація по встановленню лімітів від вендора для навантажених проектів – ліміти повинні бути в 1,5 рази більше ніж внесенні значення. Як вирахувати ліміти – дуже залежить від реєстру.

Для великих значень цей коефіцієнт можна зменшити, наприклад, до 1,2. Але в цьому прикладі ми додаємо більше ніж рекомендується, бо на таких маленьких значеннях ресурсів може не вистачити для нормальної роботи службових завдань контейнера.
====


Підтвердьте зміни, відкрийте Запити на оновлення та схваліть новий запит.

image:registry-admin-study/task-registry-resources-management/image-5.png[]

Перейдіть до сервісу Jenkins за посиланням CI.
image:registry-admin-study/task-registry-resources-management/image-6.png[]

Проконтролюйте процес виконання пайплайну MASTER-Build-<registry-name>.

image:registry-admin-study/task-registry-resources-management/image-7.png[]

Після завершення процесу виконання зі статусом SUCCESS, перевірте результат в OKD-консолі.
image:registry-admin-study/task-registry-resources-management/image-8.png[]


Перейдіть до Workloads > Deployments > відкрийте bpms і знайдіть containers на вкладці YAML.

В блоці containers з’явиться блок з вказаними значеннями в resourses
image:registry-admin-study/task-registry-resources-management/image-9.png[]

[NOTE]
====
Зверніть увагу, що налаштування лімітів є важливою складовою роботи реєстру і вказано в вимогах при аудиті реєстру.

*Важливо* проводити xref:registry-develop:audit/registry-audit/registry-audit-instruction.adoc[аудит реєстру] на відповідність вимогам.
====

== Як побачити проблему (на практиці):

1. Якщо контейнер буде часто перезавантажуватися.
image:registry-admin-study/task-registry-resources-management/image-10.png[]
2. В дашборді Графани Spring Boot, при відображенні роботи обраної поди, на графіку використання пам’яті буде нерівномірне навантаження. Наприклад
image:registry-admin-study/task-registry-resources-management/image-11.png[]

* Також, якщо Heep Used доходить або майже доходить до червоної зони – це є ще одним додатковим показником необхідності додати ресурсів.

Правильний графік виглядає так
image:registry-admin-study/task-registry-resources-management/image-12.png[]